FROM alpine:latest
MAINTAINER Nick "facelook@163.com"
LABEL Maintainer="ouathq.com <facelook@163.com>" \
      license="MIT" \
      version="1.0" \
      Description="Lightweight container with PHP-FPM 7.4.14 based on Alpine Linux." \
      vcs-url="https://github.com/oauthq/dockerfile"

ENV REFERSHED_AT 2020-02-03
ENV TIMEZONE Asia/Shanghai
ENV PHP_VERSION 7.4

RUN set -xe \
    && sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories \
    && apk add --update --no-cache --virtual .persistent-deps \
    ca-certificates wget curl vim zip unzip tar \
    iproute2 \
    openssh-client \
    libmemcached-libs \
    libevent \
    musl \
    yaml \
    # https://github.com/docker-library/php/issues/494
    #libressl \
    php7 php7-fpm php7-gd php7-common php7-apcu php7-bcmath php7-ctype php7-curl php7-dom php7-iconv php7-intl php7-json php7-openssl \
    php7-opcache php7-mbstring php7-memcached php7-mysqlnd php7-mysqli php7-pcntl php7-pgsql php7-pdo_mysql php7-pdo_pgsql php7-pdo_sqlite php7-phar php7-posix php7-session php7-soap php7-sockets php7-sodium php7-xml php7-xmlreader php7-zip php7-zlib php7-redis php7-pear php7-fileinfo \
    # 安装 Composer，PHP 用来管理依赖关系的工具  https://install.phpcomposer.com/installer
    && curl -sS https://getcomposer.org/installer \
        | php7 -- --install-dir=/usr/bin --filename=composer \
    && apk add --no-cache --repository http://dl-cdn.alpinelinux.org/alpine/edge/testing/ --allow-untrusted \
    gnu-libiconv \
    && echo "done"

#时区配置
RUN set -x \
    && apk add tzdata \
    && ln -snf /usr/share/zoneinfo/${TIMEZONE} /etc/localtime \
    && echo "${TIMEZONE}" > /etc/timezone

ADD ./docker-php/* /usr/local/bin/

ENV PHP_INI_DIR /etc/php7
ENV PHP_CLI_DIR /usr/bin/php7
ENV PHP_CLI_DIR_CONFIG /usr/bin/php-config7
ENV PHPIZE_DEPS \
        autoconf \
        g++ \
        gcc \
        make \
        libc-dev \
        libmcrypt-dev

RUN set -xe \
    && apk add --no-cache --repository "http://mirrors.aliyun.com/alpine/edge/testing" \
    --virtual  \
    $PHPIZE_DEPS

#add lrzsz
RUN wget https://ohse.de/uwe/releases/lrzsz-0.12.20.tar.gz
RUN tar -xf lrzsz-0.12.20.tar.gz
RUN cd lrzsz-0.12.20 && ./configure \
    && make && make install
RUN ln -s /usr/local/bin/lrz /usr/local/bin/rz && ln -s /usr/local/bin/lsz /usr/local/bin/sz

#使用本地PHP配置
ADD ./conf/php.ini $PHP_INI_DIR/php.ini
RUN sed -i -e "s/;daemonize\s*=\s*yes/daemonize = no/g" /etc/php7/php-fpm.conf \
    && sed -i -e "s/listen\s*=\s*127.0.0.1:9000/listen = 9000/g" /etc/php7/php-fpm.d/www.conf

#删除安装库
RUN rm -rf /var/cache/apk/* \
    && echo "done"

#运行设置home 目录 www-data 权限
ADD ./script/run.sh /
RUN chmod +x /run.sh
RUN sh /run.sh && rm /run.sh

WORKDIR /home

#http,websocket
EXPOSE 9000

ENTRYPOINT ["docker-php-entrypoint"]

CMD ["-F"]

##"--pid","/dev/shm/php-fpm.pid","-y","/etc/php7/php-fpm.conf"
##<autogenerated>##
